# 头像上传问题修复说明

## 问题分析

用户在保存头像URL时遇到错误：
```json
{
    "status": 400,
    "error": "Bad Request",
    "message": "avatarUrl: 头像URL不能为空",
    "path": "/api/users/me/avatar",
    "timestamp": "2025-10-14T22:00:25.6065719"
}
```

## 根本原因

这个问题是由于JSON字段映射不当导致的：
1. 使用 `@NotEmpty` 注解，它对于某些情况下的空白字符串处理不够严格
2. 缺少明确的 `@JsonProperty` 注解来指定JSON字段名称
3. 没有足够的日志来帮助诊断问题

## 解决方案

### 1. 修复AvatarUrlRequest.java

**修改前：**
```java
@NotEmpty(message = "头像URL不能为空")
private String avatarUrl;
```

**修改后：**
```java
@NotBlank(message = "头像URL不能为空")
@JsonProperty("avatarUrl")
private String avatarUrl;
```

**改进点：**
- `@NotBlank` 比 `@NotEmpty` 更严格，会检查空白字符
- `@JsonProperty("avatarUrl")` 明确指定JSON字段名称，确保正确映射
- 导入了 `com.fasterxml.jackson.annotation.JsonProperty`

### 2. 添加日志到UserController

在 `saveUserAvatar` 方法中添加了日志：
```java
logger.info("Received avatar URL: {}", avatarUrlRequest.getAvatarUrl());
logger.info("Current user: {}", currentUser.getUsername());
logger.info("Avatar updated successfully for user: {}", currentUser.getUsername());
```

这样可以在后端日志中看到请求的详细信息，便于调试。

## 新增功能

### 1. 图片格式验证

只允许JPG和PNG格式：
```java
private static final List<String> ALLOWED_EXTENSIONS = Arrays.asList(".jpg", ".jpeg", ".png");
private static final List<String> ALLOWED_CONTENT_TYPES = Arrays.asList("image/jpeg", "image/png");
```

验证逻辑：
- 检查文件的 Content-Type
- 检查文件扩展名
- 两者都必须是允许的格式

### 2. 文件大小验证

限制文件大小为5MB：
```java
private static final long MAX_FILE_SIZE = 5 * 1024 * 1024;

if (file.getSize() > MAX_FILE_SIZE) {
    return ResponseEntity.badRequest().body("文件大小不能超过5MB");
}
```

### 3. 图片尺寸验证

检查图片的实际像素尺寸：
```java
private static final int MAX_WIDTH = 2000;
private static final int MAX_HEIGHT = 2000;
private static final int MIN_WIDTH = 50;
private static final int MIN_HEIGHT = 50;

BufferedImage image = ImageIO.read(file.getInputStream());
int width = image.getWidth();
int height = image.getHeight();

// 检查最小尺寸
if (width < MIN_WIDTH || height < MIN_HEIGHT) {
    return ResponseEntity.badRequest()
        .body(String.format("图片尺寸太小，最小尺寸为%dx%d像素", MIN_WIDTH, MIN_HEIGHT));
}

// 检查最大尺寸
if (width > MAX_WIDTH || height > MAX_HEIGHT) {
    return ResponseEntity.badRequest()
        .body(String.format("图片尺寸太大，最大尺寸为%dx%d像素", MAX_WIDTH, MAX_HEIGHT));
}
```

## 测试步骤

### 步骤1：上传头像（会进行验证）
```http
POST http://localhost:8080/api/files/upload/avatar
Authorization: Bearer {token}
Content-Type: multipart/form-data

Body: form-data
- key: file
- type: File
- value: 选择一个JPG或PNG图片（小于5MB，尺寸在50x50到2000x2000之间）

期望返回：
{
    "url": "/uploads/avatars/{uuid}.jpg"
}
```

**可能的错误响应：**
- `"只支持JPG和PNG格式的图片"` - 如果上传了其他格式
- `"文件大小不能超过5MB"` - 如果文件太大
- `"图片尺寸太小，最小尺寸为50x50像素"` - 如果图片太小
- `"图片尺寸太大，最大尺寸为2000x2000像素"` - 如果图片太大

### 步骤2：保存头像URL（已修复）
```http
POST http://localhost:8080/api/users/me/avatar
Authorization: Bearer {token}
Content-Type: application/json

Body:
{
    "avatarUrl": "/uploads/avatars/{uuid}.jpg"
}

期望返回：
{
    "id": 2,
    "username": "seconduser",
    "email": "seconduser@lost.com",
    "avatarUrl": "/uploads/avatars/{uuid}.jpg"
}
```

**注意：**
- JSON字段名必须是 `avatarUrl`（驼峰命名）
- 值不能为空字符串或只包含空格

### 步骤3：验证
```http
GET http://localhost:8080/api/users/me
Authorization: Bearer {token}

期望返回：
{
    "id": 2,
    "username": "seconduser",
    "email": "seconduser@lost.com",
    "avatarUrl": "/uploads/avatars/{uuid}.jpg"
}
```

## 技术细节

### 使用的Java库
- `javax.imageio.ImageIO` - 用于读取和验证图片
- `java.awt.image.BufferedImage` - 用于获取图片尺寸
- `com.fasterxml.jackson.annotation.JsonProperty` - 用于JSON映射
- `org.slf4j.Logger` - 用于日志记录

### 验证顺序
1. 文件是否为空
2. 文件大小是否超限
3. Content-Type是否是允许的类型
4. 文件扩展名是否是允许的格式
5. 文件是否是有效的图片（能被ImageIO读取）
6. 图片尺寸是否在允许的范围内

只有通过所有验证后，文件才会被保存。

## 调试建议

如果仍然遇到问题，可以：

1. **查看后端日志**：现在会输出接收到的avatarUrl和当前用户信息
2. **检查请求格式**：确保Content-Type是`application/json`
3. **检查JSON字段名**：必须使用`avatarUrl`（不是`avatar_url`或其他）
4. **检查token**：确保token有效且未过期
5. **检查图片文件**：确保符合所有验证要求

## 修改的文件

1. `backend/blog/src/main/java/com/lost/blog/dto/AvatarUrlRequest.java`
2. `backend/blog/src/main/java/com/lost/blog/controller/UserController.java`
3. `backend/blog/src/main/java/com/lost/blog/controller/FileController.java`
4. `AVATAR_UPLOAD_FIX.md`
