# 草稿箱功能测试指南

本指南帮助您测试草稿箱功能的修复是否成功。

## 前置条件

1. 确保后端服务已启动
2. 确保前端开发服务器已启动
3. 确保有一个测试用户账号

## 测试步骤

### 1. 创建测试数据

#### 创建已发布文章
1. 登录系统
2. 点击"创建文章"按钮
3. 填写标题和内容
4. **不要**勾选"保存为草稿"
5. 点击"发布"按钮
6. 验证文章创建成功

#### 创建草稿文章
1. 点击"创建文章"按钮
2. 填写标题和内容  
3. **勾选**"保存为草稿"
4. 点击"保存"按钮
5. 验证草稿保存成功

建议创建至少：
- 2篇已发布文章
- 2篇草稿文章

### 2. 验证个人中心显示

#### 检查统计数字
1. 进入个人中心页面
2. 查看页面顶部的统计信息
3. 验证：
   - ✅ "文章"数字应该显示已发布文章的数量（例如：2）
   - ✅ "草稿"数字应该显示草稿文章的数量（例如：2）

#### 检查"我的文章"标签
1. 确保"我的文章"标签被选中（高亮显示）
2. 验证：
   - ✅ 显示所有已发布的文章
   - ✅ 每篇文章**没有**"草稿"标签
   - ✅ 文章显示发布时间

#### 检查"草稿箱"标签
1. 点击"草稿箱"标签
2. 验证：
   - ✅ 显示所有草稿文章
   - ✅ 每篇文章带有黄色的"草稿"标签
   - ✅ 显示创建时间和更新时间
   - ✅ **没有**显示已发布的文章

### 3. 验证浏览器控制台日志

#### 打开开发者工具
1. 按 F12 或右键选择"检查"
2. 切换到"Console"标签

#### 查看日志输出
刷新个人中心页面，应该看到类似以下的日志：

```
当前用户的所有文章（包括草稿）: 4
文章列表详情: [
  { id: 1, title: "测试文章1", draft: false, draftType: "boolean" },
  { id: 2, title: "测试文章2", draft: false, draftType: "boolean" },
  { id: 3, title: "草稿1", draft: true, draftType: "boolean" },
  { id: 4, title: "草稿2", draft: true, draftType: "boolean" }
]
统计 - 草稿数: 2 已发布: 2
```

验证要点：
- ✅ draft 字段是布尔值（`true` 或 `false`），不是字符串
- ✅ draftType 显示为 "boolean"
- ✅ 草稿数和已发布数的总和等于文章总数

### 4. 验证后端日志

查看后端服务器控制台，应该看到类似：

```
INFO  - 查询用户 testuser 的所有文章（包括草稿），总数: 4
DEBUG - 用户文章 - ID: 1, 标题: 测试文章1, 草稿状态: false
DEBUG - 用户文章 - ID: 2, 标题: 测试文章2, 草稿状态: false
DEBUG - 用户文章 - ID: 3, 标题: 草稿1, 草稿状态: true
DEBUG - 用户文章 - ID: 4, 标题: 草稿2, 草稿状态: true
```

### 5. 测试草稿编辑和发布

#### 编辑草稿
1. 在草稿箱中，点击某篇草稿的"编辑"按钮
2. 修改内容
3. 保持"保存为草稿"勾选状态
4. 保存
5. 验证：
   - ✅ 文章仍然在草稿箱中
   - ✅ 内容已更新

#### 发布草稿
1. 在草稿箱中，点击某篇草稿的"编辑"按钮
2. **取消勾选**"保存为草稿"
3. 保存
4. 验证：
   - ✅ 文章从草稿箱消失
   - ✅ 文章出现在"我的文章"中
   - ✅ 统计数字正确更新

### 6. 测试已发布文章转为草稿

1. 在"我的文章"中，点击某篇文章的"编辑"按钮
2. **勾选**"保存为草稿"
3. 保存
4. 验证：
   - ✅ 文章从"我的文章"消失
   - ✅ 文章出现在草稿箱中
   - ✅ 带有"草稿"标签
   - ✅ 统计数字正确更新

### 7. 测试空状态

#### 清空草稿箱
1. 删除或发布所有草稿
2. 点击"草稿箱"标签
3. 验证显示：
   - ✅ 空状态图标
   - ✅ "草稿箱为空"提示
   - ✅ "你还没有草稿，去创作第一篇草稿吧！"说明文字

#### 清空已发布文章
1. 删除所有已发布文章（或将它们都转为草稿）
2. 点击"我的文章"标签
3. 验证显示：
   - ✅ 空状态图标
   - ✅ "还没有发布文章"提示

### 8. 数据库验证（可选）

如果想直接检查数据库数据：

```bash
cd backend/debug_scripts
mysql -u your_username -p your_database_name < check_draft_status.sql
```

或在 MySQL 客户端中：
```sql
SELECT id, title, is_draft, user_id, created_at 
FROM posts 
ORDER BY created_at DESC;
```

验证：
- ✅ is_draft 字段值为 0（false）或 1（true）
- ✅ 草稿文章的 is_draft = 1
- ✅ 已发布文章的 is_draft = 0

## 常见问题排查

### 问题1：草稿箱仍然是空的

**可能原因**：
- 后端服务未重启
- 前端未刷新缓存

**解决方法**：
1. 重启后端服务
2. 清除浏览器缓存（Ctrl+Shift+Delete）
3. 硬刷新页面（Ctrl+Shift+R）

### 问题2：统计数字不正确

**检查步骤**：
1. 查看浏览器控制台的日志
2. 确认 draft 字段的类型是 boolean
3. 确认过滤逻辑正确执行

### 问题3：看到其他用户的草稿

这是一个**严重的安全问题**！请立即报告。

**验证方法**：
1. 创建两个用户账号
2. 用户A创建草稿
3. 用户B登录并查看草稿箱
4. 用户B**不应该**看到用户A的草稿

### 问题4：401 Unauthorized 错误

**可能原因**：
- 未登录或登录已过期
- JWT token 无效

**解决方法**：
1. 重新登录
2. 检查 localStorage 中的 token
3. 检查后端认证配置

## API 测试（使用 curl 或 Postman）

### 测试新接口

```bash
# 获取当前用户的所有文章（需要认证）
curl -X GET "http://localhost:8080/api/posts/my?page=0&size=10" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

预期响应：
```json
{
  "content": [
    {
      "id": 1,
      "title": "文章标题",
      "draft": false,
      ...
    },
    {
      "id": 2,
      "title": "草稿标题",
      "draft": true,
      ...
    }
  ],
  "totalElements": 4,
  ...
}
```

### 测试公共接口

```bash
# 获取所有已发布文章（无需认证）
curl -X GET "http://localhost:8080/api/posts?page=0&size=10"
```

预期响应：
- 只包含 `draft: false` 的文章
- 不包含任何草稿

## 性能测试

### 大量数据测试

1. 创建 100+ 篇文章（50篇已发布，50篇草稿）
2. 访问个人中心
3. 验证：
   - ✅ 页面加载速度合理
   - ✅ 列表滚动流畅
   - ✅ 统计数字正确

## 测试完成确认

完成所有测试后，确认以下各项：

- [ ] 草稿箱能正确显示用户的草稿文章
- [ ] 已发布文章和草稿文章能正确分类显示
- [ ] 统计数字准确无误
- [ ] 可以在草稿箱中编辑和管理草稿
- [ ] 草稿可以发布，已发布文章可以转为草稿
- [ ] 不同用户之间草稿互不可见
- [ ] 空状态显示正确
- [ ] 浏览器控制台无错误信息
- [ ] 后端日志显示正确

## 清理调试日志

测试完成并确认功能正常后，可以移除调试日志：

1. 移除后端的 `logger.debug()` 调试语句
2. 移除前端的 `console.log()` 调试语句
3. 保留正常的 `logger.info()` 和 `logger.warn()` 日志

## 问题反馈

如果在测试过程中发现任何问题，请提供：
1. 复现步骤
2. 浏览器控制台截图
3. 后端日志相关部分
4. 数据库查询结果（如果相关）
