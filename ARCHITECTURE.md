# 部署架构图

## 传统部署架构

```
┌─────────────────────────────────────────────────────┐
│                    服务器                            │
│                                                      │
│  ┌────────────────────────────────────────────┐    │
│  │              Nginx (端口 80/443)            │    │
│  │                                              │    │
│  │  ┌──────────────┐      ┌──────────────┐   │    │
│  │  │  静态文件     │      │   API 代理    │   │    │
│  │  │  (Vue 前端)  │      │   /api -> :8080│   │    │
│  │  └──────────────┘      └──────────────┘   │    │
│  └────────────────────────────────────────────┘    │
│                          │                          │
│                          ▼                          │
│  ┌────────────────────────────────────────────┐    │
│  │      Spring Boot 应用 (端口 8080)          │    │
│  │                                              │    │
│  │  • JWT 认证                                 │    │
│  │  • RESTful API                              │    │
│  │  • 业务逻辑                                  │    │
│  └────────────────────────────────────────────┘    │
│                          │                          │
│                          ▼                          │
│  ┌────────────────────────────────────────────┐    │
│  │      MySQL 数据库 (端口 3306)              │    │
│  │                                              │    │
│  │  • 用户数据                                  │    │
│  │  • 文章数据                                  │    │
│  └────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────┘

外部访问:
用户浏览器 ─── HTTPS (443) ───> Nginx ───> 静态文件 / API 代理
```

## Docker 部署架构

```
┌─────────────────────────────────────────────────────┐
│                  Docker Host                        │
│                                                      │
│  ┌────────────────────────────────────────────┐    │
│  │       Docker Network (blog-network)        │    │
│  │                                              │    │
│  │  ┌──────────────────────────────────────┐  │    │
│  │  │  Frontend Container (端口 80)        │  │    │
│  │  │                                        │  │    │
│  │  │  • Nginx                               │  │    │
│  │  │  • Vue 静态文件                        │  │    │
│  │  │  • API 反向代理                        │  │    │
│  │  └──────────────────────────────────────┘  │    │
│  │                  │                          │    │
│  │                  ▼                          │    │
│  │  ┌──────────────────────────────────────┐  │    │
│  │  │  Backend Container (端口 8080)       │  │    │
│  │  │                                        │  │    │
│  │  │  • OpenJDK 17                          │  │    │
│  │  │  • Spring Boot JAR                     │  │    │
│  │  │  • 环境变量配置                        │  │    │
│  │  └──────────────────────────────────────┘  │    │
│  │                  │                          │    │
│  │                  ▼                          │    │
│  │  ┌──────────────────────────────────────┐  │    │
│  │  │  MySQL Container (端口 3306)         │  │    │
│  │  │                                        │  │    │
│  │  │  • MySQL 8.0                           │  │    │
│  │  │  • 数据卷持久化                        │  │    │
│  │  │  • 健康检查                            │  │    │
│  │  └──────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────┘

外部访问:
用户浏览器 ─── HTTP (80) ───> Frontend Container ───> Backend Container ───> MySQL Container
```

## 配置流程

```
开发环境                          生产环境
───────────                      ───────────

application.properties           application-prod.properties
(硬编码配置)                      (环境变量配置)
      │                                  │
      │                                  │
      ▼                                  ▼
本地 MySQL                         .env 文件
localhost:3306              ──────────────────────
root/437179745              DATABASE_URL=...
                            DATABASE_PASSWORD=***
                            JWT_SECRET=***
                                      │
                                      │
                                      ▼
                              Spring Boot 应用
                              (生产模式运行)
```

## 部署方式对比

| 特性 | Docker 部署 | 传统部署 |
|------|-------------|----------|
| 难度 | ⭐⭐ 简单 | ⭐⭐⭐⭐ 较复杂 |
| 一键启动 | ✅ docker-compose up -d | ❌ 需手动启动各服务 |
| 环境隔离 | ✅ 完全隔离 | ⚠️ 依赖宿主机环境 |
| 端口管理 | ✅ 容器网络 | ⚠️ 需手动配置 |
| 扩展性 | ✅ 易于扩展 | ⚠️ 需要更多配置 |
| 资源占用 | 稍高（容器开销） | 较低 |
| 适用场景 | 快速部署、云服务器 | 传统服务器、精细控制 |

## 环境变量传递

```
┌───────────────┐
│  .env 文件    │
│               │
│  KEY=VALUE    │
└───────┬───────┘
        │
        ▼
┌──────────────────────────────┐
│  Docker Compose 或 Shell    │
│                              │
│  读取并导出环境变量          │
└──────────┬───────────────────┘
           │
           ▼
┌─────────────────────────────┐
│  Spring Boot 应用           │
│                              │
│  ${KEY} 替换为实际值        │
│                              │
│  application-prod.properties│
│  spring.datasource.url=     │
│    ${DATABASE_URL}           │
└─────────────────────────────┘
```

## 安全层次

```
┌─────────────────────────────────────────┐
│         安全层 1: 网络防火墙            │
│  • 只开放 80, 443 端口                  │
│  • 限制 SSH 访问                        │
└────────────┬────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────┐
│         安全层 2: HTTPS 加密            │
│  • Let's Encrypt SSL 证书               │
│  • TLS 1.2+                             │
└────────────┬────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────┐
│         安全层 3: JWT 认证              │
│  • Bearer Token                         │
│  • 短期 token + 长期 token              │
│  • 自动刷新机制                         │
└────────────┬────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────┐
│         安全层 4: 数据库权限            │
│  • 独立数据库用户                       │
│  • 限制访问权限                         │
│  • 加密敏感字段                         │
└─────────────────────────────────────────┘
```

## 数据流向

### 用户登录流程

```
浏览器                前端              后端 API            数据库
  │                   │                  │                  │
  │  输入账号密码      │                  │                  │
  ├──────────────────>│                  │                  │
  │                   │  POST /api/users/login            │
  │                   ├─────────────────>│                  │
  │                   │                  │  验证用户信息     │
  │                   │                  ├─────────────────>│
  │                   │                  │<─────────────────┤
  │                   │                  │  用户数据         │
  │                   │                  │                  │
  │                   │                  │  生成 JWT Token  │
  │                   │<─────────────────┤                  │
  │                   │  { token: "..." }│                  │
  │  保存到 localStorage                 │                  │
  │<──────────────────┤                  │                  │
  │                   │                  │                  │
```

### API 请求流程

```
浏览器                前端              后端 API            数据库
  │                   │                  │                  │
  │  访问我的文章      │                  │                  │
  ├──────────────────>│                  │                  │
  │                   │  检查 token 是否过期              │
  │                   │  (5分钟内过期自动刷新)            │
  │                   │                  │                  │
  │                   │  GET /api/posts/my                │
  │                   │  Header: Authorization: Bearer xxx│
  │                   ├─────────────────>│                  │
  │                   │                  │  验证 JWT        │
  │                   │                  │  提取用户信息     │
  │                   │                  │                  │
  │                   │                  │  查询文章         │
  │                   │                  ├─────────────────>│
  │                   │                  │<─────────────────┤
  │                   │                  │  文章列表         │
  │                   │<─────────────────┤                  │
  │                   │  { content: [...] }               │
  │  渲染页面          │                  │                  │
  │<──────────────────┤                  │                  │
```

## 部署检查清单

### 部署前
- [ ] 准备服务器（Linux, 2GB+ 内存）
- [ ] 安装必要软件（Java/Docker, MySQL）
- [ ] 准备域名（可选）
- [ ] 生成 JWT 密钥
- [ ] 配置环境变量文件

### 部署中
- [ ] 创建数据库和用户
- [ ] 构建后端应用
- [ ] 构建前端应用
- [ ] 配置 Nginx（如果需要）
- [ ] 首次启动创建数据库表
- [ ] 配置自动启动

### 部署后
- [ ] 验证前端可以访问
- [ ] 验证后端 API 正常
- [ ] 测试用户注册登录
- [ ] 测试文章 CRUD 功能
- [ ] 配置 HTTPS
- [ ] 设置定期备份
- [ ] 配置监控告警
