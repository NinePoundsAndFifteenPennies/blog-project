# 头像上传功能修复说明

## 问题描述

1. 上传文件时报错：`Failed to parse multipart servlet request`
2. 保存头像URL时返回 `avatarUrl: null`

## 修复内容

### 1. 添加文件上传配置（修复multipart错误）

在 `application.properties` 添加：
```properties
# 文件上传配置
spring.servlet.multipart.enabled=true
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=10MB
file.upload-dir=uploads/avatars/
```

### 2. 实现完整的头像上传功能

修改的文件：
- `User.java` - 添加avatarUrl字段
- `FileController.java` - 实现文件上传端点
- `UserController.java` - 添加头像保存端点，修改/me返回完整对象
- `UserService.java` - 添加updateAvatar方法
- `UserServiceImpl.java` - 实现updateAvatar，使用@Transactional确保持久化
- `UserResponse.java` - 添加avatarUrl字段
- `UserMapper.java` - 实现实体到DTO映射
- `WebConfig.java` - 配置静态资源访问

## 使用方法

### 第一步：上传头像文件
```http
POST /api/files/upload/avatar
Content-Type: multipart/form-data

参数名：file
参数值：选择图片文件

返回：
{
  "url": "/uploads/avatars/xxx.jpg"
}
```

### 第二步：保存头像URL
```http
POST /api/users/me/avatar
Authorization: Bearer {你的token}
Content-Type: application/json

{
  "avatarUrl": "/uploads/avatars/xxx.jpg"
}

返回：
{
  "id": 2,
  "username": "seconduser",
  "email": "seconduser@lost.com",
  "avatarUrl": "/uploads/avatars/xxx.jpg"
}
```

### 第三步：获取用户信息
```http
GET /api/users/me
Authorization: Bearer {你的token}

返回：
{
  "id": 2,
  "username": "seconduser",
  "email": "seconduser@lost.com",
  "avatarUrl": "/uploads/avatars/xxx.jpg"
}
```

## 关键修复点

1. **multipart配置** - 解决文件上传报错
2. **@Transactional注解** - 确保头像URL保存到数据库
3. **完整的数据流** - 上传→保存→查询全链路打通
