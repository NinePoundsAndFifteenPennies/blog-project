# å¤´åƒä¸Šä¼ åŠŸèƒ½Bugä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆåœ¨ä½¿ç”¨Postmanæµ‹è¯•å¤´åƒä¸Šä¼ åŠŸèƒ½æ—¶å‘ç°ï¼š
- `http://localhost:8080/api/files/upload/avatar` å¯ä»¥æ­£ç¡®è·å–å¤´åƒURL
- `http://localhost:8080/api/users/me/avatar` ä¿å­˜æ—¶ä¼šè¿”å› `avatarUrl: null`

ç¤ºä¾‹å“åº”ï¼š
```json
{
    "id": 2,
    "username": "seconduser",
    "email": "seconduser@lost.com",
    "avatarUrl": null  // â† è¿™é‡Œåº”è¯¥æœ‰URLï¼Œä½†æ˜¯æ˜¯null
}
```

## Bugæ ¹æºåˆ†æ

é€šè¿‡ä»£ç å®¡æŸ¥ï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜ï¼š

### 1. æ•°æ®æ¨¡å‹å±‚ (User.java)
**é—®é¢˜ï¼š** Userå®ä½“ç±»ç¼ºå°‘`avatarUrl`å­—æ®µ
- æ•°æ®åº“è¡¨ä¸­å³ä½¿æœ‰`avatar_url`åˆ—ï¼ŒJavaå¯¹è±¡ä¹Ÿæ— æ³•æ˜ å°„
- å³ä½¿èµ‹å€¼ä¹Ÿæ— æ³•æŒä¹…åŒ–åˆ°æ•°æ®åº“

### 2. æœåŠ¡å±‚ (UserService.java / UserServiceImpl.java)
**é—®é¢˜ï¼š** ç¼ºå°‘æ›´æ–°å¤´åƒçš„æ–¹æ³•
- æ²¡æœ‰`updateAvatar()`æ–¹æ³•æ¥æ›´æ–°ç”¨æˆ·å¤´åƒ
- æ²¡æœ‰`findByUsername()`æ–¹æ³•æ¥æŸ¥æ‰¾ç”¨æˆ·å®Œæ•´ä¿¡æ¯
- å³ä½¿æœ‰æ–¹æ³•ï¼Œç¼ºå°‘`@Transactional`æ³¨è§£ä¼šå¯¼è‡´æ•°æ®ä¸æŒä¹…åŒ–

### 3. æ§åˆ¶å™¨å±‚ (UserController.java)
**é—®é¢˜1ï¼š** ç¼ºå°‘`POST /api/users/me/avatar`ç«¯ç‚¹
- æ²¡æœ‰APIç«¯ç‚¹æ¥æ¥æ”¶å‰ç«¯å‘é€çš„å¤´åƒURL

**é—®é¢˜2ï¼š** `GET /api/users/me`è¿”å›å­—ç¬¦ä¸²è€Œä¸æ˜¯ç”¨æˆ·å¯¹è±¡
```java
// åŸæ¥çš„ä»£ç 
return ResponseEntity.ok("å½“å‰ç™»å½•ç”¨æˆ·æ˜¯: " + currentUser.getUsername());
```
- å‰ç«¯æ— æ³•è·å–åŒ…å«å¤´åƒåœ¨å†…çš„å®Œæ•´ç”¨æˆ·ä¿¡æ¯

### 4. æ–‡ä»¶ä¸Šä¼ æ§åˆ¶å™¨ (FileController.java)
**é—®é¢˜ï¼š** ç©ºå®ç°
- è™½ç„¶ç”¨æˆ·æåˆ°å¯ä»¥è·å–URLï¼Œä½†FileControlleræ˜¯ç©ºçš„
- éœ€è¦å®Œæ•´å®ç°æ–‡ä»¶ä¸Šä¼ é€»è¾‘

### 5. DTOå±‚
**é—®é¢˜ï¼š** ç¼ºå°‘åˆé€‚çš„å“åº”å¯¹è±¡
- UserResponse.javaæ˜¯ç©ºç±»
- æ²¡æœ‰UserMapperæ¥è½¬æ¢å®ä½“åˆ°DTO

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹1: User.java - æ·»åŠ avatarUrlå­—æ®µ
```java
@Column(name = "avatar_url")
private String avatarUrl;

public String getAvatarUrl() {
    return avatarUrl;
}

public void setAvatarUrl(String avatarUrl) {
    this.avatarUrl = avatarUrl;
}
```

### ä¿®æ”¹2: UserService.java - æ·»åŠ æ–¹æ³•å®šä¹‰
```java
User updateAvatar(String username, String avatarUrl);
User findByUsername(String username);
```

### ä¿®æ”¹3: UserServiceImpl.java - å®ç°æ–¹æ³•
```java
@Override
@Transactional  // â† å…³é”®ï¼šç¡®ä¿æ•°æ®æŒä¹…åŒ–
public User updateAvatar(String username, String avatarUrl) {
    User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new RuntimeException("ç”¨æˆ·ä¸å­˜åœ¨"));
    user.setAvatarUrl(avatarUrl);
    return userRepository.save(user);  // â† ä¿å­˜åˆ°æ•°æ®åº“
}

@Override
public User findByUsername(String username) {
    return userRepository.findByUsername(username)
            .orElseThrow(() -> new RuntimeException("ç”¨æˆ·ä¸å­˜åœ¨"));
}
```

**å…³é”®ç‚¹ï¼š**
- `@Transactional`æ³¨è§£ç¡®ä¿æ•°æ®åº“äº‹åŠ¡æ­£ç¡®æäº¤
- `userRepository.save(user)`å°†æ›´æ”¹æŒä¹…åŒ–åˆ°æ•°æ®åº“

### ä¿®æ”¹4: FileController.java - å®ç°æ–‡ä»¶ä¸Šä¼ 
```java
@PostMapping("/upload/avatar")
public ResponseEntity<?> uploadAvatar(@RequestParam("file") MultipartFile file) {
    // 1. éªŒè¯æ–‡ä»¶ä¸ä¸ºç©º
    // 2. åˆ›å»ºä¸Šä¼ ç›®å½• uploads/avatars/
    // 3. ç”ŸæˆUUIDæ–‡ä»¶åé˜²æ­¢å†²çª
    // 4. ä¿å­˜æ–‡ä»¶
    // 5. è¿”å›æ–‡ä»¶è®¿é—®URL
    return ResponseEntity.ok(Map.of("url", fileUrl));
}
```

### ä¿®æ”¹5: UserController.java - æ·»åŠ å’Œä¿®æ”¹ç«¯ç‚¹

#### 5a. ä¿®æ”¹GET /api/users/me
```java
@GetMapping("/me")
public ResponseEntity<?> getCurrentUser(@AuthenticationPrincipal UserDetails currentUser) {
    if (currentUser == null) {
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("æœªç™»å½•");
    }
    // è·å–å®Œæ•´ç”¨æˆ·ä¿¡æ¯
    User user = userService.findByUsername(currentUser.getUsername());
    UserResponse userResponse = userMapper.toResponse(user);
    return ResponseEntity.ok(userResponse);  // â† è¿”å›å®Œæ•´å¯¹è±¡ï¼ŒåŒ…æ‹¬avatarUrl
}
```

#### 5b. æ·»åŠ POST /api/users/me/avatar
```java
@PostMapping("/me/avatar")
public ResponseEntity<?> updateAvatar(
        @AuthenticationPrincipal UserDetails currentUser,
        @RequestBody Map<String, String> request) {
    
    String avatarUrl = request.get("avatarUrl");
    if (avatarUrl == null || avatarUrl.trim().isEmpty()) {
        return ResponseEntity.badRequest().body("å¤´åƒURLä¸èƒ½ä¸ºç©º");
    }
    
    // æ›´æ–°ç”¨æˆ·å¤´åƒ
    User updatedUser = userService.updateAvatar(
        currentUser.getUsername(), 
        avatarUrl
    );
    UserResponse userResponse = userMapper.toResponse(updatedUser);
    return ResponseEntity.ok(userResponse);  // â† è¿”å›æ›´æ–°åçš„å®Œæ•´ä¿¡æ¯
}
```

### ä¿®æ”¹6: UserResponse.java - åˆ›å»ºå®Œæ•´DTO
```java
public class UserResponse {
    private Long id;
    private String username;
    private String email;
    private String avatarUrl;  // â† åŒ…å«å¤´åƒå­—æ®µ
    // æ„é€ å‡½æ•°ã€getterã€setter
}
```

### ä¿®æ”¹7: UserMapper.java - å®ç°æ˜ å°„
```java
@Component
public class UserMapper {
    public UserResponse toResponse(User user) {
        return new UserResponse(
            user.getId(),
            user.getUsername(),
            user.getEmail(),
            user.getAvatarUrl()  // â† æ˜ å°„å¤´åƒå­—æ®µ
        );
    }
}
```

### ä¿®æ”¹8: WebConfig.java - é…ç½®é™æ€èµ„æº
```java
@Override
public void addResourceHandlers(ResourceHandlerRegistry registry) {
    // é…ç½®é™æ€èµ„æºè®¿é—®ï¼Œä½¿ä¸Šä¼ çš„å¤´åƒå¯ä»¥é€šè¿‡URLè®¿é—®
    registry.addResourceHandler("/uploads/avatars/**")
            .addResourceLocations("file:uploads/avatars/");
}
```

## ä½¿ç”¨æµç¨‹

### ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å¤´åƒæ–‡ä»¶
```bash
POST http://localhost:8080/api/files/upload/avatar
Content-Type: multipart/form-data

file: [é€‰æ‹©å›¾ç‰‡æ–‡ä»¶]

å“åº”ï¼š
{
  "url": "/uploads/avatars/abc-123-def.jpg"
}
```

### ç¬¬äºŒæ­¥ï¼šä¿å­˜å¤´åƒURLåˆ°ç”¨æˆ·ä¿¡æ¯
```bash
POST http://localhost:8080/api/users/me/avatar
Authorization: Bearer [your-jwt-token]
Content-Type: application/json

{
  "avatarUrl": "/uploads/avatars/abc-123-def.jpg"
}

å“åº”ï¼š
{
  "id": 2,
  "username": "seconduser",
  "email": "seconduser@lost.com",
  "avatarUrl": "/uploads/avatars/abc-123-def.jpg"  // â† ç°åœ¨æœ‰å€¼äº†ï¼
}
```

### ç¬¬ä¸‰æ­¥ï¼šè·å–ç”¨æˆ·ä¿¡æ¯éªŒè¯
```bash
GET http://localhost:8080/api/users/me
Authorization: Bearer [your-jwt-token]

å“åº”ï¼š
{
  "id": 2,
  "username": "seconduser",
  "email": "seconduser@lost.com",
  "avatarUrl": "/uploads/avatars/abc-123-def.jpg"  // â† æŒä¹…åŒ–æˆåŠŸï¼
}
```

## æ•°æ®æµå›¾

```
å‰ç«¯ä¸Šä¼ æ–‡ä»¶
    â†“
FileController.uploadAvatar()
    â†“
ä¿å­˜åˆ° uploads/avatars/ç›®å½•
    â†“
è¿”å›URLç»™å‰ç«¯
    â†“
å‰ç«¯è°ƒç”¨ POST /api/users/me/avatar å¹¶ä¼ å…¥URL
    â†“
UserController.updateAvatar()
    â†“
UserService.updateAvatar()  â† @Transactional
    â†“
user.setAvatarUrl(url)
    â†“
userRepository.save(user)
    â†“
æ•°æ®åº“ users è¡¨çš„ avatar_url å­—æ®µæ›´æ–°  âœ…
    â†“
è¿”å›æ›´æ–°åçš„UserResponseç»™å‰ç«¯
```

## å…³é”®æŠ€æœ¯ç‚¹

### 1. @Transactional çš„é‡è¦æ€§
```java
@Transactional  // â† æ²¡æœ‰è¿™ä¸ªæ³¨è§£ï¼Œæ›´æ”¹å¯èƒ½ä¸ä¼šä¿å­˜åˆ°æ•°æ®åº“ï¼
public User updateAvatar(String username, String avatarUrl) {
    user.setAvatarUrl(avatarUrl);
    return userRepository.save(user);
}
```

**ä½œç”¨ï¼š**
- ç¡®ä¿æ•°æ®åº“äº‹åŠ¡æ­£ç¡®å¼€å§‹ã€æäº¤
- å‡ºé”™æ—¶è‡ªåŠ¨å›æ»š
- é¿å…æ•°æ®ä¸ä¸€è‡´

### 2. å®ä½“ä¸DTOçš„åˆ†ç¦»
- **User**: JPAå®ä½“ï¼ŒåŒ…å«passwordç­‰æ•æ„Ÿä¿¡æ¯
- **UserResponse**: å“åº”DTOï¼ŒåªåŒ…å«å¯ä»¥è¿”å›ç»™å‰ç«¯çš„å­—æ®µ
- **UserMapper**: è´Ÿè´£è½¬æ¢ï¼Œéš”ç¦»æ•æ„Ÿæ•°æ®

### 3. æ–‡ä»¶ä¸Šä¼ çš„å®‰å…¨æ€§
- ä½¿ç”¨UUIDç”Ÿæˆå”¯ä¸€æ–‡ä»¶åï¼Œé¿å…æ–‡ä»¶åå†²çª
- å¯ä»¥æ·»åŠ æ–‡ä»¶ç±»å‹éªŒè¯ï¼ˆå¦‚åªå…è®¸jpgã€pngï¼‰
- å¯ä»¥æ·»åŠ æ–‡ä»¶å¤§å°é™åˆ¶

## Bugä¿®å¤éªŒè¯

### ä¿®å¤å‰ âŒ
```json
POST /api/users/me/avatar
{
  "avatarUrl": "/uploads/avatars/test.jpg"
}

å“åº”ï¼š
{
  "id": 2,
  "username": "seconduser", 
  "email": "seconduser@lost.com",
  "avatarUrl": null  // â† Bug: è¿”å›null
}

æ•°æ®åº“: avatar_urlåˆ—ä»ç„¶æ˜¯NULL
```

### ä¿®å¤å âœ…
```json
POST /api/users/me/avatar
{
  "avatarUrl": "/uploads/avatars/test.jpg"
}

å“åº”ï¼š
{
  "id": 2,
  "username": "seconduser",
  "email": "seconduser@lost.com", 
  "avatarUrl": "/uploads/avatars/test.jpg"  // â† æ­£ç¡®è¿”å›
}

æ•°æ®åº“: avatar_url = "/uploads/avatars/test.jpg"  â† å·²ä¿å­˜
```

## æ€»ç»“

è¿™ä¸ªBugçš„æ ¸å¿ƒé—®é¢˜æ˜¯**æ•°æ®æŒä¹…åŒ–é“¾è·¯ä¸å®Œæ•´**ï¼š

1. âŒ æ¨¡å‹ç¼ºå­—æ®µ â†’ æ— æ³•å­˜å‚¨
2. âŒ æœåŠ¡ç¼ºæ–¹æ³• â†’ æ— æ³•æ›´æ–°
3. âŒ ç¼ºå°‘@Transactional â†’ æ— æ³•æŒä¹…åŒ–
4. âŒ æ§åˆ¶å™¨ç¼ºç«¯ç‚¹ â†’ æ— æ³•è°ƒç”¨
5. âŒ å“åº”ä¸å®Œæ•´ â†’ æ— æ³•éªŒè¯

ç°åœ¨æ‰€æœ‰ç¯èŠ‚éƒ½å·²å®Œå–„ï¼š
1. âœ… Useræ¨¡å‹æœ‰avatarUrlå­—æ®µ
2. âœ… UserServiceæœ‰updateAvataræ–¹æ³•
3. âœ… ä½¿ç”¨@Transactionalç¡®ä¿æŒä¹…åŒ–
4. âœ… UserControlleræœ‰å®Œæ•´ç«¯ç‚¹
5. âœ… è¿”å›å®Œæ•´UserResponseå¯¹è±¡

**Bugå·²å½»åº•ä¿®å¤ï¼** ğŸ‰
